name: Build and Push Docker Images

on:
  push:
    branches:
      - main

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1
  ARTIFACT_REGISTRY: us-central1-docker.pkg.dev
  REPOSITORY_NAME: hackathon-repo

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      patient: ${{ steps.filter.outputs.patient }}
      application: ${{ steps.filter.outputs.application }}
      order: ${{ steps.filter.outputs.order }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            patient:
              - 'patient-service/**'
            application:
              - 'application-service/**'
            order:
              - 'order-service/**'

  build-patient:
    needs: check-changes
    if: needs.check-changes.outputs.patient == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }} --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push patient-service
        uses: docker/build-push-action@v5
        with:
          context: ./patient-service
          push: true
          tags: ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/patient-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-application:
    needs: check-changes
    if: needs.check-changes.outputs.application == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }} --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push application-service
        uses: docker/build-push-action@v5
        with:
          context: ./application-service
          push: true
          tags: ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/application-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-order:
    needs: check-changes
    if: needs.check-changes.outputs.order == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }} --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push order-service
        uses: docker/build-push-action@v5
        with:
          context: ./order-service
          push: true
          tags: ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/order-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max


# ... 

  deploy:
    name: Deploy to GKE
    # This ensures deployment only happens after builds are finished
    needs: [build-patient, build-application, build-order]
    
    # Run this job if the previous jobs were successful (or skipped because of no changes)
    if: always() && (needs.build-patient.result == 'success' || needs.build-patient.result == 'skipped')
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Authenticate to Google Cloud
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 2. Setup Cloud SDK
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      # 3. Install kubectl helper
      - name: Install kubectl
        run: gcloud components install kubectl --quiet

      # 4. Get Credentials for your specific Cluster
      - name: 'Get GKE credentials'
        uses: 'google-github-actions/get-gke-credentials@v2'
        with:
          cluster_name: 'autopilot-cluster-1'   # Your manual cluster name
          location: 'us-central1'               # Your manual cluster region

      # 5. Deploy the manifests from the k8s folder
      - name: 'Deploy to GKE'
        run: |
          echo "Applying Kubernetes manifests..."
          kubectl apply -f k8s/

          # Force a restart of the deployments to ensure they pick up the 'latest' image we just pushed
          echo "Restarting deployments to pull new images..."
          kubectl rollout restart deployment/patient-service || true
          kubectl rollout restart deployment/order-service || true
          kubectl rollout restart deployment/application-service || true

          # Check status
          echo "Deployment status:"
          kubectl get services